# 第十一章 测试概述

测试是编程的一部分。事实上，当你第一次编写计算机程序时，你肯定会将一些样本数据作为输入写入计算机程序，来观测它是否如你所期望的那样运行。很长一段时间以来，软件测试的测试过程都显得非常类似，很大程度上是手动进行的并且容易出错。然而，自21世纪初以来，软件行业的测试方法发生了巨大的变化，以应对现代软件系统的规模和复杂性。这一演变的核心是开发驱动的自动化测试实践。

自动化测试可以发现绝大多数漏洞并防止漏洞影响软件用户使用。在开发周期中，一个漏洞被发现的越晚，修复漏洞的代价就越大；并且在许多情况下是指数级增长的。然而，“发现漏洞”只是自动化测试的动机的一部分。你想要测试你的软件的一个相当重要的原因是支持更新换代的能力。无论是添加新功能、进行基于代码规范的代码重构，还是进行更大规模的重新设计，自动化测试都可以快速发现错误，使软件更新换代成为可能。

迭代更新速度更快的公司可以更快地适应不断变化的技术、市场条件和客户爱好。如果你有一个健壮的测试流程，你不必害怕改变 — 你可以把它作为开发软件的一个基本品质。当你越想更快更全面地改变你的系统，你就越需要一种快速的方法来测试它们。

编写测试的行为也改进了系统的设计。作为代码的第一个客户，测试可以告诉你很多关于设计选择的问题。比如，您的系统与数据库的耦合是否过于紧密？接口是否支持要求的用例？您的系统能处理所有的边缘样例吗？编写自动化测试迫使你在早期开发周期就考虑这些问题。这样做通常会导致软件更模块化，从而在以后实现更大的灵活性。

关于软件测试这个主题，已经有了很多的研究成果，而且有很好的理由: 对于这样一个重要的实践来说，做好它对许多人来说似乎仍然是一项神秘的工作。在谷歌，虽然我们已经取得了很大的进步，但我们仍然面临着使我们的流程在整个公司可靠扩展的难题。在这一章中，我们将分享一些我们所学到的东西，以帮助进一步的讨论。

## 我们为什么编写测试？

为了更好地理解如何最大限度地利用测试，让我们从头开始描述。当我们谈论自动化测试时，我们真正在谈论什么？

最简单的测试是这么定义的：

 - 只进行单个行为的测试，通常是你正在调用的方法或应用程序接口
 - 只有一个特定的输入，你传递给应用程序接口的一些数值
 - 可观察的输出或行为
 - 可控制的环境，如单个隔离过程

当你执行这样的测试，将输入传递给系统并验证输出时，你将了解系统是否如你所期望的那样运行。总的来说，数百或数千个简单的测试(通常称为测试套件)可以告诉你，你的整个产品符合预期设计的程度，更重要的是，当它不符合预期设计时，测试也会提醒你。

创建和维护一个健壮的测试套件需要真正的努力。随着代码库的增长，测试套件也会增长。它将开始面临不稳定和缓慢等挑战。如果不能解决这些问题，测试套件就会瘫痪。请记住，测试的价值来自工程师对它们的信任。如果测试成为生产力的一个阻碍，不断地引发辛劳和不确定性，工程师将失去信任，并开始寻找解决办法。一个糟糕的测试套件可能比没有测试套件更糟糕。

除了让公司能够快速制造出优秀的产品，在我们的生活中测试对于确保重要产品和服务安全至关重要。软件比以往任何时候都更加深入我们的生活，缺陷会导致很多烦恼：它们会花费大量的金钱，损失财产，或者最糟糕的是，导致我们失去美好生活。

在谷歌，我们已经确定测试不能是开发完成后的想法。关注质量和测试是我们工作的一部分。我们已经深刻地认识到，无法将质量融入我们的产品和服务不可避免地会导致糟糕的结果。因此，我们已经将测试纳入了我们工程文化的核心。

### 谷歌网络服务器的故事

在谷歌早期，工程师驱动的测试通常被认为不重要。团队经常依靠聪明的人来保证软件的正确。一些系统运行大型集成测试，但主要还是在开拓时期。一种产品似乎受到了特别严重的影响：它是谷歌网络服务器，也被称为GWS。

GWS是负责服务谷歌搜索查询的网络服务器，它对谷歌搜索的重要性不亚于机场的空中交通控制。早在2005年，随着项目规模和复杂性的膨胀，生产率急剧下降。发布变得越来越麻烦，推出它们需要越来越长的时间。团队成员在对服务进行更改时信心不足，并且通常只有在功能停止工作时才发现有问题。(另一点，超过80%的生产推送包含影响用户的漏洞，这些漏洞必须回滚。)

为了解决这些问题，GWS的技术负责人(TL)决定制定一项由工程师驱动的自动化测试政策。作为该策略的一部分，所有新的代码更改都需要包含测试，并且这些测试将持续运行。在制定这项政策的一年内，紧急推送的数量减少了一半。尽管该项目每个季度都有创纪录的变化，但这种减少还是发生了。即使面对前所未有的增长和变化，测试也给谷歌最关键的项目带来了新的生产力和信心。今天，GWS有成千上万的测试，并且几乎每天都发布只有相对较少的客户可见的漏洞。

GWS的变化标志着谷歌测试文化的分水岭，因为公司其他部门的团队看到了测试的好处，并采取了类似的策略。

GWS的经历告诉我们的一个关键观点是你不能仅仅依靠程序员的能力来避免产品缺陷。即使每个工程师只编写很少的错误，当你有足够的人在同一个项目上工作时，你将被不断增长的缺陷清单淹没。想象一个100人的团队，他们的工程师非常优秀，每个人每个月只写一个漏洞。总体来说，这群了不起的工程师每个工作日仍然会产生五个新的漏洞。更糟糕的是，在一个复杂的系统中，修复一个错误往往会导致另一个错误，因为工程师可能基于已知的错误并编写接下来的代码。

最好的团队会想办法将成员的集体智慧转化为整个团队的利益。这正是自动化测试所做的。在团队中的一个工程师编写了一个测试后，它被添加到其他人可用的公共资源池中。团队中的其他每个人现在都可以运行测试，并且当它检测到问题时将会受益。与此形成对比的是基于调试的方法，在这种方法中，每次错误发生时，工程师都必须花费用调试器深入调查的开销。工程资源的成本日以继夜投入，这是GWS能够扭转其命运的根本原因。

### 以现代化发展的速度进行测试

软件系统变得越来越大，越来越复杂。谷歌的典型应用程序或服务由数千或数百万行代码组成。它使用各种库或框架，通过不可靠的网络交付给越来越多的平台，这些平台运行着无数的配置。更糟糕的是，新版本频繁被推送给用户，甚至有时一天多次。这与一年只更新一两次的安装包包装软件的世界相去甚远。

人类手动验证系统中每个功能的能力已经跟不上大多数软件中功能和平台的爆炸式增长。想象一下手动测试谷歌搜索的所有功能需要什么，例如寻找航班、电影时间、相关图像，当然还有网络搜索结果(见图11-1)。即使你能确定如何解决这个问题，你也需要将这个工作量乘以谷歌搜索必须支持的每种语言、国家和设备，并且不要忘记检查可访问性和安全性。试图通过要求人们手动与每一个特征交互来评估产品质量是不可行的。谈到测试，有一个明确的答案可以实现这一点：自动化。
![image-20210428183927257](https://gitee.com/yyjjtt/picture_bed/raw/master/img/image-20210428183927257.png)

### 编程，运行，反应

在其最纯粹的形式中，自动化测试由三个活动组成：编写测试、运行测试和对测试失败做出反应。自动化测试是一小段代码，通常是一个单独的函数或方法，它调用你想要测试的更大系统的一个独立部分。测试代码建立一个预期的环境，调用系统，通常使用一个已知的输入，并验证结果。有些测试非常小，使用单一的代码路径；另一些测试要大得多，可能涉及整个系统，比如移动操作系统或网络浏览器。

示例 11-1展示了一个谨慎的用Java进行的简单测试，不使用框架或测试库。这并不是你编写整个测试套件的方式，但是在它的核心，每个自动化测试看起来都类似于这个非常简单的例子。

*示例 11-1.一个简单的测试*

```java
// 验证计算机类可以处理一个负的结果
public void main(String[] args) {
   Calculator calculator = new Calculator();
   int expectedResult = -3;
   int actualResult = calculator.subtract(2, 5); // Given 2, Subtracts 5.
   assert(expectedResult == actualResult);
}
```

与过去的质量保证过程不同，在过去的质量保证过程中，专门的软件测试人员仔细研究系统的新版本，测试每一种可能的行为，今天构建系统的工程师在为他们自己的代码编写和运行自动化测试方面发挥着积极和不可或缺的作用。即使在质量保证是一个部门的公司里，开发人员编写测试也很常见。以当今系统开发的速度和规模，唯一的方法是让整个工程人员共享测试的开发。

当然，写测试和写好测试是不同的。培养成千上万的工程师来编写好的测试可能相当困难。我们将在接下来的章节中讨论我们所学到的关于编写好的测试的知识。

编写测试只是自动化测试过程的第一步。写完测试后，你需要运行它们。自动化测试其核心包括一遍又一遍地重复相同的动作，只有在出现故障时才需要人工注意。我们将在第23章讨论这种持续集成和测试。通过将测试表示为代码，而不是手动的一系列步骤，我们可以在每次代码更改时运行它们—很容易每天就能运行数千次。与人类测试人员不同，机器永远不会疲劳或厌倦。

将测试表示为代码的另一个好处是，很容易将它们模块化，以便在各种环境中执行。只要你已经为这两个系统进行了配置，在谷歌中进行了谷歌邮件测试就不需要在火狐中测试谷歌邮件花销更多的资源。可以使用与英语相同的测试代码来运行日语或德语用户界面的测试。

正在积极开发的产品和服务将不可避免地经历测试失败。真正使测试过程有效的是它如何解决测试失败。允许失败的测试快速堆积会破坏它们提供的任何价值，所以绝对不能让这种情况发生。优先在失败后几分钟内修复失败测试的团队能够保持高信心和快速的故障隔离，因此从他们的测试中可以获得更多的价值。

总之，健康的自动化测试文化鼓励每个人分享编写的测试。这样的文化也确保了测试的定期运行。最后，也可能是最重要的，它强调快速修复失败的测试以便在过程中保持高度的信心。

### 测试代码的好处

对于来自没有强大测试文化的组织的开发人员来说，将编写测试作为提高生产率和速度的一种手段的想法似乎是对立的。毕竟，与实现一个功能首先要做的事情相比，编写测试的行为可能需要同样长的时间(甚至更长！)。相反，在谷歌，我们发现投资软件测试对开发人员的工作效率有几个主要好处：

*__更少的调试__*  
正如你所期望的那样，测试过的代码在提交时缺陷较少。关键是，它在整个存在过程中也有较少的缺陷；他们中的大多数缺陷会在提交代码之前被抓住。谷歌的一段代码预计在被完全弃用前会被修改几十次。它将被其他团队甚至自动化代码维护系统所改变。一次编写的测试将继续带来回报，并在项目的整个生命周期中防止代价高昂的缺陷和烦人的调试会话。同时可以通过测试基础结构快速检测出破坏测试的项目更改或项目的依存关系，并在问题发布到生产环境之前回滚。

*__增强对变更的信心__*  
所有软件变更。具有良好测试的团队可以自信地评审和接受他们项目的变更，因为他们项目的所有重要行为都被不断地验证。这样的项目鼓励重构。在保留现有行为的同时重构代码的更改（理想情况下）应不需要更改现有测试。

*__改良的文档__*  
软件文档是出了名的不可靠。从过时的需求到缺失的边缘情况，文档与代码之间的关系很脆弱是很常见的。清晰、集中的测试，一次测试一个行为，起到可执行文档的作用。如果你想知道代码在特定情况下做什么，请查看该情况下的测试。更好的是，当需求改变并且新代码破坏了现有的测试时，我们得到了一个明确的信号，即“文档化”现在已经过时了。请注意，只有在注意保持测试清晰和简洁的情况下，测试作为文档才最有效。

*__更简单的审查__*  
谷歌的所有代码都要经过至少一名其他工程师的审查，然后才能提交(详见第9章)。如果代码审查包括证明代码正确性、边缘情况和错误条件的全面测试，则代码审查人员在验证代码是否如预期那样工作方面花费的精力较少。审查者可以验证每个案例都通过了测试，而不是在精神上遍历每个案例所需要的繁琐工作。

*__周到的设计__*
为新代码编写测试是练习代码本身的接口设计的一种实用方法。如果新代码难以测试，通常是因为被测试的代码有太多的分支或者难以管理的依赖关系。设计良好的代码应该是模块化的，避免紧密耦合，专注于特定的责任。尽早解决设计问题通常意味着以后更少的返工。

*__快速、高质量的发布__*    
有了一个健康的自动化测试套件，团队可以放心地发布他们应用程序的新版本。谷歌的许多项目每天都会发布一个新的生产版本—甚至是每天都有数百名工程师和数千条代码变更提交的大型项目。没有自动化测试，这是不可能的。